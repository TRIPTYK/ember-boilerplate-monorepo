# JWT Refresh Tokens - Shaping Notes

## Scope

### In Scope
- Server-side refresh token storage with SHA-256 hashing
- Token rotation on each refresh
- Family-based invalidation for theft detection
- Multi-device support (each login creates new token family)
- Single device logout and all-devices logout
- Token cleanup utility for expired tokens

### Out of Scope
- Rate limiting on refresh endpoint (can be added later)
- Device fingerprinting beyond user-agent/IP
- Push notifications for session invalidation
- Admin panel for viewing active sessions

## Key Decisions

### Why SHA-256 instead of Argon2?
Refresh tokens are already high-entropy random values (generated by JWT). SHA-256 provides:
- Fast validation on every refresh request
- Protection against database leaks (attacker can't use stolen hashes)
- No need for slow password-hashing algorithms designed for low-entropy passwords

### Why token families?
Token families enable theft detection:
- Each login creates a new family ID
- All rotated tokens share the same family ID
- If a revoked token is reused, the entire family is invalidated
- This catches replay attacks where an attacker and legitimate user both try to refresh

### Why store in database vs Redis?
- Database provides durability and consistency
- Refresh tokens are long-lived (7 days) - not suitable for volatile cache
- Enables complex queries (list all sessions, revoke by user)
- MikroORM integration is already in place

## Context

The existing auth system uses:
- Access tokens (15 min expiry, stateless)
- Refresh tokens (7 day expiry, currently stateless)

This implementation adds server-side state for refresh tokens to enable:
- Logout functionality (invalidate tokens)
- Token rotation (security best practice)
- Multi-device session management

## Technical Notes

- RefreshTokenEntity uses MikroORM's `defineEntity` pattern
- Routes follow existing class-based pattern with Zod schemas
- EntityManager is passed to routes that need database access
- All token operations are atomic within a single request
